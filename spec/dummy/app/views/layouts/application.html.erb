<!DOCTYPE html>
<html>
  <head>
    <title>Dummy App</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <script type="importmap">
      {
        "imports": {
          "@hotwired/stimulus": "https://cdn.jsdelivr.net/npm/@hotwired/stimulus@3.2.2/dist/stimulus.min.js"
        }
      }
    </script>
    <script type="module">
      import { Application, Controller } from "@hotwired/stimulus"

      window.Stimulus = Application.start()

      // nested-form controller
      class NestedFormController extends Controller {
        static values = {
          wrapperClass: { type: String, default: "nested-fields" }
        }

        add(event) {
          event.preventDefault()

          const template = event.currentTarget.dataset.template
          const insertion = event.currentTarget.dataset.insertion || "before"
          const targetSelector = event.currentTarget.dataset.target
          const count = parseInt(event.currentTarget.dataset.count) || 1

          for (let i = 0; i < count; i++) {
            this.insertFields(template, insertion, targetSelector, event.currentTarget)
          }
        }

        remove(event) {
          event.preventDefault()

          const wrapper = event.currentTarget.closest(`.${this.wrapperClassValue}`)
          if (!wrapper) return

          // Dispatch cancelable before-remove event
          const beforeEvent = this.dispatch("before-remove", {
            cancelable: true,
            detail: { wrapper }
          })

          if (beforeEvent.defaultPrevented) return

          const destroyInput = wrapper.querySelector("input[name*='_destroy']")

          if (destroyInput) {
            // Persisted record - hide and mark for destruction
            destroyInput.value = "true"
            wrapper.style.display = "none"
          } else {
            // New record - remove from DOM
            wrapper.remove()
          }

          this.dispatch("after-remove", { detail: { wrapper } })
        }

        insertFields(template, insertion, targetSelector, trigger) {
          const newId = new Date().getTime()
          const content = template.replace(/NEW_RECORD/g, newId)

          const fragment = document.createRange().createContextualFragment(content)
          const wrapper = fragment.firstElementChild

          // Dispatch cancelable before-add event
          const beforeEvent = this.dispatch("before-add", {
            cancelable: true,
            detail: { wrapper }
          })

          if (beforeEvent.defaultPrevented) return

          const container = targetSelector
            ? document.querySelector(targetSelector)
            : trigger.parentElement

          switch (insertion) {
            case "after":
              trigger.after(fragment)
              break
            case "append":
              container.append(fragment)
              break
            case "prepend":
              container.prepend(fragment)
              break
            default: // "before"
              trigger.before(fragment)
          }

          this.dispatch("after-add", { detail: { wrapper } })
        }
      }

      Stimulus.register("nested-form", NestedFormController)
    </script>
  </head>
  <body>
    <% if notice %>
      <p id="notice"><%= notice %></p>
    <% end %>
    <% if alert %>
      <p id="alert"><%= alert %></p>
    <% end %>
    <%= yield %>
  </body>
</html>
